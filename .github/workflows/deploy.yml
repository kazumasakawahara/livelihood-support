# ==============================================================================
# Deployment Pipeline for neo4j-livelihood-support
# 生活保護受給者尊厳支援データベース
# ==============================================================================
name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'デプロイ環境'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'テストをスキップ'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: "3.12"
  UV_VERSION: "0.5.11"

jobs:
  # ============================================================================
  # Pre-deployment Checks
  # ============================================================================
  pre-deploy:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=$(grep 'version = ' pyproject.toml | head -1 | sed 's/.*version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Validate environment
        run: |
          echo "Environment: ${{ inputs.environment }}"
          echo "Skip tests: ${{ inputs.skip_tests }}"

  # ============================================================================
  # Run Tests (unless skipped)
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [pre-deploy]
    if: ${{ !inputs.skip_tests }}

    services:
      neo4j:
        image: neo4j:5-community
        ports:
          - 7687:7687
          - 7474:7474
        env:
          NEO4J_AUTH: neo4j/testpassword
          NEO4J_PLUGINS: '["apoc"]'
        options: >-
          --health-cmd "wget -q --spider http://localhost:7474 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    env:
      NEO4J_URI: bolt://localhost:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: testpassword
      TESTING: "true"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Wait for Neo4j
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:7474 > /dev/null; then
              echo "Neo4j is ready!"
              break
            fi
            sleep 2
          done

      - name: Run tests
        run: |
          uv run pytest tests/ \
            --ignore=tests/e2e \
            -v \
            --tb=short

  # ============================================================================
  # Build Docker Images
  # ============================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [pre-deploy, test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          target: api
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/api:${{ needs.pre-deploy.outputs.version }}
            ghcr.io/${{ github.repository }}/api:${{ inputs.environment }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Streamlit image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          target: streamlit
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/streamlit:${{ needs.pre-deploy.outputs.version }}
            ghcr.io/${{ github.repository }}/streamlit:${{ inputs.environment }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # Deploy to Environment
  # ============================================================================
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: [pre-deploy, build]
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "Deploying to ${{ inputs.environment }}..."

          # SSH設定
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

          # デプロイスクリプト実行
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            cd $DEPLOY_PATH
            git pull origin main
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d
            docker compose -f docker-compose.prod.yml ps
          ENDSSH

      - name: Health check
        env:
          DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
        run: |
          echo "Running health check..."
          for i in {1..10}; do
            if curl -sf "$DEPLOY_URL/health" > /dev/null; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Waiting for service... ($i/10)"
            sleep 10
          done
          echo "Health check failed!"
          exit 1

      - name: Notify deployment
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.pre-deploy.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Post-deployment Validation
  # ============================================================================
  validate:
    name: Post-deployment Validation
    runs-on: ubuntu-latest
    needs: [deploy]
    if: inputs.environment == 'production'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Install Playwright
        run: uv run playwright install chromium --with-deps

      - name: Run smoke tests
        env:
          E2E_API_URL: ${{ secrets.DEPLOY_URL }}
        run: |
          uv run pytest tests/e2e/test_api_e2e.py::TestAPIHealth -v --tb=short

      - name: Notify validation result
        if: always()
        run: |
          echo "## Post-deployment Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Smoke tests: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
